{"ast":null,"code":"import React,{Fragment,useState,useEffect,useContext}from\"react\";import{useHistory}from\"react-router-dom\";import{Button,Paper,TableRow,TableHead,TableCell,TableBody,Table,makeStyles,Badge}from'@material-ui/core';// import Table from \"@mui/material/Table\";\n// import TableBody from \"@mui/material/TableBody\";\n// import TableCell from \"@mui/material/TableCell\";\n// import TableHead from \"@mui/material/TableHead\";\n// import TableRow from \"@mui/material/TableRow\";\n// import Paper from \"@mui/material/Paper\";\n// import Button from \"@mui/material/Button\";\n// import Pagination from '@mui/material/Pagination';\nimport*as XLSX from'xlsx';import api from\"../../services/api\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import{i18n}from\"../../translate/i18n\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import MainContainer from\"../../components/MainContainer\";import toastError from\"../../errors/toastError\";import{CircularProgress,FormControl,Grid,IconButton,InputLabel,MenuItem,Pagination,Select,TextField,Tooltip,Typography}from\"@mui/material\";import{UsersFilter}from\"../../components/UsersFilter\";import{TagsFilter}from\"../../components/TagsFilter\";import{WhatsappsFilter}from\"../../components/WhatsappsFilter\";import{StatusFilter}from\"../../components/StatusFilter\";import useDashboard from\"../../hooks/useDashboard\";import QueueSelectCustom from\"../../components/QueueSelectCustom\";import moment from\"moment\";// ShowTicketLogModal from \"../../components/ShowTicketLogModal\";\nimport{blue,green}from\"@mui/material/colors\";import VisibilityIcon from\"@material-ui/icons/Visibility\";import{Facebook,Forward,History,Instagram,SaveAlt,Visibility,WhatsApp}from\"@mui/icons-material\";import Autocomplete,{createFilterOptions}from'@mui/material/Autocomplete';import ContactModal from\"../../components/ContactModal\";import{red}from\"@material-ui/core/colors\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{isArray,capitalize}from\"lodash\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({mainContainer:{background:'linear-gradient(to bottom, #e0f7fa, #fff)',// Gradiente de fundo suave\npadding:'20px'},formControl:{display:'flex',flexDirection:'row',justifyContent:'center',alignItems:'center',marginBottom:'20px'},mainPaper:{flex:1,marginTop:40,borderRadius:20,border:'1px solid #ddd',// Bordas suaves\nboxShadow:'0px 4px 20px rgba(0, 0, 0, 0.1)',// Sombra suave\nmarginBottom:40,overflow:'hidden',backgroundColor:'#f8f9fa'},mainPaperTable:{flex:1,overflow:'auto',height:'68vh',borderRadius:'10px',backgroundColor:'#ffffff',boxShadow:'0px 2px 10px rgba(0, 0, 0, 0.05)',// Sombra leve\n...theme.scrollbarStylesSoftBig},mainPaperFilter:{flex:1,overflow:'auto',height:'30vh',padding:'20px',// Adicionando padding interno\nbackgroundColor:'#f1f3f4',borderRadius:'10px',boxShadow:'0px 2px 10px rgba(0, 0, 0, 0.05)',...theme.scrollbarStylesSoftBig},mainHeaderBlock:{[theme.breakpoints.down('xl')]:{display:'flex',flexWrap:'wrap'}},filterItem:{width:200,[theme.breakpoints.down('xl')]:{width:'45%'},marginBottom:'10px'// Espaçamento entre filtros\n},connectionTag:{background:'#4caf50',color:'#FFF',padding:'5px 10px',fontWeight:'bold',borderRadius:'15px',// Bordas arredondadas\nfontSize:'0.8em',whiteSpace:'nowrap'},button:{backgroundColor:'#1976d2',// Azul material design\ncolor:'#fff','&:hover':{backgroundColor:'#1565c0'// Azul escuro no hover\n},margin:'5px',// Espaçamento entre botões\nboxShadow:'0px 2px 10px rgba(0, 0, 0, 0.1)'// Sombra leve\n},iconButton:{color:'#4caf50',// Verde no ícone\n'&:hover':{color:'#388e3c'// Verde mais escuro no hover\n},transition:'color 0.3s ease'// Transição suave de cor\n}}));const Relatorios=()=>{const classes=useStyles();const history=useHistory();const initialContact={id:\"\",name:\"\"};const[currentContact,setCurrentContact]=useState(initialContact);const{getReport}=useDashboard();const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[pageSize,setPageSize]=useState(10);// Defina o tamanho da página\nconst[selectedWhatsapp,setSelectedWhatsapp]=useState([]);const[selectedStatus,setSelectedStatus]=useState([]);const{user}=useContext(AuthContext);// const [tagIds, setTagIds] = useState([]);\nconst[queueIds,setQueueIds]=useState([]);const[ticketId,setTicketId]=useState('');const[userIds,setUserIds]=useState([]);const[dateFrom,setDateFrom]=useState(moment(\"1\",\"D\").format(\"YYYY-MM-DD\"));const[dateTo,setDateTo]=useState(moment().format(\"YYYY-MM-DD\"));const[totalTickets,setTotalTickets]=useState(0);const[tickets,setTickets]=useState([]);const[contacts,setContacts]=useState([initialContact]);const[searchParam,setSearchParam]=useState(\"\");const[hasMore,setHasMore]=useState(false);const[openTicketMessageDialog,setOpenTicketMessageDialog]=useState(false);const[ticketOpen,setTicketOpen]=useState(null);const StatusCell=_ref=>{let{ticket}=_ref;const green='green';const red='#f44336';const gray='#9e9e9e';let backgroundColor;switch(ticket===null||ticket===void 0?void 0:ticket.status){case'ABERTO':backgroundColor=green;break;case'FECHADO':backgroundColor=red;break;case'PENDENTE':backgroundColor=gray;break;default:backgroundColor='transparent';}return/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.connectionTag,style:{backgroundColor},children:ticket===null||ticket===void 0?void 0:ticket.status});};const QueueCell=_ref2=>{let{ticket}=_ref2;const green='green';const red='#f44336';const gray='#9e9e9e';let backgroundColor;if(ticket.queueColor===null){backgroundColor=gray;}else{backgroundColor=ticket.queueColor;}return/*#__PURE__*/_jsx(TableCell,{align:\"center\",className:classes.connectionTag,style:{backgroundColor},children:(ticket===null||ticket===void 0?void 0:ticket.queueName)===null?'SEM FILA':ticket===null||ticket===void 0?void 0:ticket.queueName});};useEffect(()=>{const{companyId}=user;try{(async()=>{const{data:contactList}=await api.get('/contacts/list',{params:{companyId:companyId}});let customList=contactList.map(c=>({id:c.id,name:c.name}));if(isArray(customList)){setContacts([{id:\"\",name:\"\"},...customList]);}})();}catch(err){toastError(err);}},[user]);useEffect(()=>{if((user===null||user===void 0?void 0:user.profile)==='user'){console.log('entrei4');setUserIds([user.id]);}},[user]);// const handleSelectedTags = (selecteds) => {\n//   const tags = selecteds.map((t) => t.id);\n//   setTagIds(tags);\n// };\nconst exportarGridParaExcel=async()=>{setLoading(true);// Define o estado de loading como true durante o carregamento\ntry{const data=await getReport({searchParam,currentContact,whatsappId:JSON.stringify(selectedWhatsapp),// tags: JSON.stringify(tagIds),\nusers:JSON.stringify(userIds),queueIds:JSON.stringify(queueIds),status:JSON.stringify(selectedStatus),// tags: tagIds,\ndateFrom,dateTo,page:1,// Passa o número da página para a API\npageSize:9999999// Passa o tamanho da página para a API\n});const ws=XLSX.utils.json_to_sheet(data.tickets);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'RelatorioDeAtendimentos');XLSX.writeFile(wb,'relatorio-de-atendimentos.xlsx');setPageNumber(pageNumber);// Atualiza o estado da página atual\n}catch(error){toastError(error);}finally{setLoading(false);// Define o estado de loading como false após o carregamento\n}};const handleFilter=async pageNumber=>{setLoading(true);// Define o estado de loading como true durante o carregamento\nif(user.profile==='user'){console.log('entrei3');setUserIds([user.id]);}console.log(userIds);try{const data=await getReport({searchParam,ticketId,contactId:currentContact===null||currentContact===void 0?void 0:currentContact.id,whatsappId:JSON.stringify(selectedWhatsapp),// tags: JSON.stringify(tagIds),\nusers:JSON.stringify(userIds),queueIds:JSON.stringify(queueIds),status:JSON.stringify(selectedStatus),// tags: tagIds,\ndateFrom,dateTo,page:pageNumber,// Passa o número da página para a API\npageSize:pageSize// Passa o tamanho da página para a API\n});setTotalTickets(data.totalTickets.total);// Verifica se há mais resultados para definir hasMore\nsetHasMore(data.tickets.length===pageSize);setTickets(data.tickets);// Se for a primeira página, substitua os tickets\nsetPageNumber(pageNumber);// Atualiza o estado da página atual\n}catch(error){toastError(error);}finally{setLoading(false);// Define o estado de loading como false após o carregamento\n}};const handleSelectedUsers=selecteds=>{const users=selecteds.map(t=>t.id);const userVerify=selecteds.every(t=>t.id===user.id);console.log(userVerify);try{if(user.profile==='admin'||user.profile==='supervisor'){console.log('entrei');const users=selecteds.map(t=>t.id);setUserIds(users);}else if(!userVerify){toastError('Você não tem permissão para filtrar tickets de outros usuários');setUserIds([]);}else if(userVerify&&user.profile==='user'){console.log('entrei2');setUserIds([user.id]);}}catch(error){}};const handleSelectedWhatsapps=selecteds=>{const whatsapp=selecteds.map(t=>t.id);setSelectedWhatsapp(whatsapp);};const handleSelectedStatus=selecteds=>{const statusFilter=selecteds.map(t=>t.status);setSelectedStatus(statusFilter);};return/*#__PURE__*/_jsxs(MainContainer,{className:classes.mainContainer,children:[/*#__PURE__*/_jsx(Title,{children:i18n.t(\"reports.title\")}),/*#__PURE__*/_jsx(MainHeader,{className:classes.mainHeaderFilter,style:{display:'flex'},children:/*#__PURE__*/_jsxs(Paper,{className:classes.mainPaperFilter,children:[/*#__PURE__*/_jsx(\"div\",{style:{paddingTop:'15px'}}),/*#__PURE__*/_jsxs(Grid,{container:true,spacing:1,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,xl:3,children:/*#__PURE__*/_jsx(FormControl,{variant:\"outlined\",fullWidth:true,children:/*#__PURE__*/_jsx(Autocomplete,{fullWidth:true,value:currentContact,options:contacts,onChange:(e,contact)=>{const contactId=contact?contact.id:'';setCurrentContact(contact?contact:initialContact);},getOptionLabel:option=>option.name,getOptionSelected:(option,value)=>{return value.id===option.id;},renderInput:params=>/*#__PURE__*/_jsx(TextField,{...params,variant:\"outlined\",placeholder:\"Contato\"})})})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,xl:3,children:/*#__PURE__*/_jsx(WhatsappsFilter,{onFiltered:handleSelectedWhatsapps})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,xl:3,children:/*#__PURE__*/_jsx(StatusFilter,{onFiltered:handleSelectedStatus})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,xl:3,children:/*#__PURE__*/_jsx(UsersFilter,{onFiltered:handleSelectedUsers})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,md:3,xl:3,style:{marginTop:'-13px'},children:/*#__PURE__*/_jsx(QueueSelectCustom,{selectedQueueIds:queueIds,onChange:values=>setQueueIds(values)})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,md:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Ticket ID\",type:\"text\",value:ticketId,variant:\"outlined\",fullWidth:true,size:\"small\",onChange:e=>{setTicketId(e.target.value);}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,md:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Data Inicial\",type:\"date\",value:dateFrom,variant:\"outlined\",fullWidth:true,size:\"small\",onChange:e=>setDateFrom(e.target.value),InputLabelProps:{shrink:true}})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:3,md:3,children:/*#__PURE__*/_jsx(TextField,{label:\"Data Final\",type:\"date\",value:dateTo,variant:\"outlined\",fullWidth:true,size:\"small\",onChange:e=>setDateTo(e.target.value),InputLabelProps:{shrink:true}})}),/*#__PURE__*/_jsxs(Grid,{item:true,xs:12,sm:3,md:3,style:{display:'flex-end',justifyContent:'center'},children:[/*#__PURE__*/_jsx(IconButton,{onClick:exportarGridParaExcel,\"aria-label\":\"Exportar para Excel\",size:\"large\",children:/*#__PURE__*/_jsx(SaveAlt,{})}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:()=>handleFilter(pageNumber),size:\"small\",children:i18n.t(\"reports.buttons.filter\")})]})]})]})}),/*#__PURE__*/_jsx(Paper,{className:classes.mainPaperTable,variant:\"outlined\",children:/*#__PURE__*/_jsxs(Table,{size:\"small\",id:\"grid-attendants\",children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"reports.table.id\")}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:i18n.t(\"reports.table.whatsapp\")}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:i18n.t(\"reports.table.contact\")}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:i18n.t(\"reports.table.user\")}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:i18n.t(\"reports.table.queue\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"reports.table.status\")}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:i18n.t(\"reports.table.lastMessage\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"reports.table.dateOpen\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"reports.table.dateClose\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"reports.table.actions\")})]})}),/*#__PURE__*/_jsx(TableBody,{children:/*#__PURE__*/_jsxs(_Fragment,{children:[tickets.map(ticket=>/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:ticket.id}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:ticket===null||ticket===void 0?void 0:ticket.whatsappName}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:ticket===null||ticket===void 0?void 0:ticket.contactName}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:ticket===null||ticket===void 0?void 0:ticket.userName}),/*#__PURE__*/_jsx(QueueCell,{ticket:ticket}),/*#__PURE__*/_jsx(StatusCell,{ticket:ticket}),/*#__PURE__*/_jsx(TableCell,{align:\"left\",children:ticket===null||ticket===void 0?void 0:ticket.lastMessage}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:ticket===null||ticket===void 0?void 0:ticket.createdAt}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:ticket===null||ticket===void 0?void 0:ticket.closedAt}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:/*#__PURE__*/_jsx(Typography,{noWrap:true,component:\"span\",variant:\"body2\",color:\"textPrimary\",children:/*#__PURE__*/_jsx(Tooltip,{title:\"Acessar Ticket\",children:/*#__PURE__*/_jsx(VisibilityIcon,{onClick:()=>{history.push(`/tickets/${ticket.uuid}`);},fontSize:\"small\",color:\"primary\",style:{cursor:\"pointer\",marginLeft:10,verticalAlign:\"middle\"}})})})})]},ticket.id)),loading&&/*#__PURE__*/_jsx(TableRowSkeleton,{avatar:true,columns:3})]})})]})}),/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsxs(Grid,{container:true,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:10,md:10,children:/*#__PURE__*/_jsx(Pagination,{count:Math.ceil(totalTickets/pageSize)// Calcula o nmero total de páginas com base no nmero total de tickets e no tamanho da página\n,page:pageNumber// Define a página atual\n,onChange:(event,value)=>handleFilter(value)// Função de callback para mudanças de página\n})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:12,sm:2,md:2,children:/*#__PURE__*/_jsxs(FormControl,{margin:\"dense\",variant:\"outlined\",fullWidth:true,children:[/*#__PURE__*/_jsx(InputLabel,{children:i18n.t(\"tickets.search.ticketsPerPage\")}),/*#__PURE__*/_jsxs(Select,{labelId:\"dialog-select-prompt-label\",id:\"dialog-select-prompt\",name:\"pageSize\",value:pageSize,onChange:e=>{setPageSize(e.target.value);},label:i18n.t(\"tickets.search.ticketsPerPage\"),fullWidth:true,MenuProps:{anchorOrigin:{vertical:\"center\",horizontal:\"left\"},transformOrigin:{vertical:\"center\",horizontal:\"left\"},getContentAnchorEl:null},children:[/*#__PURE__*/_jsx(MenuItem,{value:5,children:\"5\"}),/*#__PURE__*/_jsx(MenuItem,{value:10,children:\"10\"}),/*#__PURE__*/_jsx(MenuItem,{value:20,children:\"20\"}),/*#__PURE__*/_jsx(MenuItem,{value:50,children:\"50\"}),/*#__PURE__*/_jsx(MenuItem,{value:100,children:\"100\"})]})]})})]})})]});};export default Relatorios;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}