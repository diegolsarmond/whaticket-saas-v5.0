{"ast":null,"code":"import React,{useContext,useEffect,useRef,useState}from\"react\";import clsx from\"clsx\";import{format,isSameDay,parseISO}from\"date-fns\";import{useHistory,useParams}from\"react-router-dom\";import Avatar from\"@material-ui/core/Avatar\";import Badge from\"@material-ui/core/Badge\";import Box from\"@material-ui/core/Box\";import Divider from\"@material-ui/core/Divider\";import ListItem from\"@material-ui/core/ListItem\";import ListItemAvatar from\"@material-ui/core/ListItemAvatar\";import ListItemSecondaryAction from\"@material-ui/core/ListItemSecondaryAction\";import ListItemText from\"@material-ui/core/ListItemText\";import Typography from\"@material-ui/core/Typography\";import{blue,green,grey}from\"@material-ui/core/colors\";import{makeStyles}from\"@material-ui/core/styles\";import FaceIcon from\"@material-ui/icons/Face\";import{i18n}from\"../../translate/i18n\";import{Chip,Tooltip}from\"@material-ui/core\";import{v4 as uuidv4}from\"uuid\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{TicketsContext}from\"../../context/Tickets/TicketsContext\";import toastError from\"../../errors/toastError\";import api from\"../../services/api\";import ButtonWithSpinner from\"../ButtonWithSpinner\";import MarkdownWrapper from\"../MarkdownWrapper\";import AndroidIcon from\"@material-ui/icons/Android\";import VisibilityIcon from\"@material-ui/icons/Visibility\";import ContactTag from\"../ContactTag\";import TicketMessagesDialog from\"../TicketMessagesDialog\";import TransferTicketModalCustom from\"../TransferTicketModalCustom\";import{getInitials}from\"../../helpers/getInitials\";import{generateColor}from\"../../helpers/colorGenerator\";import{jsx as _jsx,Fragment as _Fragment,jsxs as _jsxs}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({ticket:{position:\"relative\"},pendingTicket:{cursor:\"unset\"},queueTag:{background:\"#FCFCFC\",color:\"#000\",marginRight:1,padding:1,fontWeight:\"bold\",paddingLeft:5,paddingRight:5,borderRadius:3,fontSize:\"0.8em\",whiteSpace:\"nowrap\"},noTicketsDiv:{display:\"flex\",height:\"100px\",margin:40,flexDirection:\"column\",alignItems:\"center\",justifyContent:\"center\"},newMessagesCount:{position:\"absolute\",alignSelf:\"center\",marginRight:8,marginLeft:\"auto\",top:\"10px\",left:\"20px\",borderRadius:0},noTicketsText:{textAlign:\"center\",color:\"rgb(104, 121, 146)\",fontSize:\"14px\",lineHeight:\"1.4\"},connectionTag:{background:\"green\",color:\"#FFF\",marginRight:1,padding:1,fontWeight:\"bold\",paddingLeft:5,paddingRight:5,borderRadius:3,fontSize:\"0.8em\",whiteSpace:\"nowrap\"},noTicketsTitle:{textAlign:\"center\",fontSize:\"16px\",fontWeight:\"600\",margin:\"0px\"},contactNameWrapper:{display:\"flex\",justifyContent:\"space-between\",marginLeft:\"5px\"},lastMessageTime:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",top:-21,background:\"#333333\",color:\"#ffffff\",border:\"1px solid #3a3b6c\",borderRadius:5,padding:1,paddingLeft:5,paddingRight:5,fontSize:\"0.9em\"},closedBadge:{alignSelf:\"center\",justifySelf:\"flex-end\",marginRight:32,marginLeft:\"auto\"},contactLastMessage:{paddingRight:\"0%\",marginLeft:\"5px\"},badgeStyle:{color:\"white\",backgroundColor:green[500]},acceptButton:{position:\"absolute\",right:\"108px\"},acceptButton:{position:\"absolute\",left:\"50%\"},ticketQueueColor:{flex:\"none\",width:\"8px\",height:\"100%\",position:\"absolute\",top:\"0%\",left:\"0%\"},ticketInfo:{position:\"relative\",top:-13},secondaryContentSecond:{display:\"flex\",// marginTop: 5,\n//marginLeft: \"5px\",\nalignItems:\"flex-start\",flexWrap:\"wrap\",flexDirection:\"row\",alignContent:\"flex-start\"},ticketInfo1:{position:\"relative\",top:13,right:0},Radiusdot:{\"& .MuiBadge-badge\":{borderRadius:2,position:\"inherit\",height:16,margin:2,padding:3},\"& .MuiBadge-anchorOriginTopRightRectangle\":{transform:\"scale(1) translate(0%, -40%)\"}},presence:{color:(theme===null||theme===void 0?void 0:theme.mode)===\"light\"?\"blue\":\"lightgreen\",fontWeight:\"bold\"}}));{}const TicketListItemCustom=_ref=>{var _ticket$queue5,_ticket$queue5$name,_ticket$queue6,_ticket$contact,_ticket$contact2,_ticket$contact3,_ticket$contact4,_ticket$contact5,_ticket$contact6,_ticket$whatsapp,_ticket$whatsapp2,_ticket$whatsapp2$nam,_ticket$queue7,_ticket$queue8,_ticket$queue8$name;let{ticket}=_ref;const classes=useStyles();const history=useHistory();const[loading,setLoading]=useState(false);const[ticketUser,setTicketUser]=useState(null);const[ticketQueueName,setTicketQueueName]=useState(null);const[ticketQueueColor,setTicketQueueColor]=useState(null);const[tag,setTag]=useState([]);const[whatsAppName,setWhatsAppName]=useState(null);const[lastInteractionLabel,setLastInteractionLabel]=useState(\"\");const[openTicketMessageDialog,setOpenTicketMessageDialog]=useState(false);const{ticketId}=useParams();const isMounted=useRef(true);const{setCurrentTicket}=useContext(TicketsContext);const{user}=useContext(AuthContext);const[verpreview,setverpreview]=useState(false);const{profile}=user;const[transferTicketModalOpen,setTransferTicketModalOpen]=useState(false);const presenceMessage={composing:\"Digitando...\",recording:\"Gravando...\"};useEffect(()=>{var _ticket$queue,_ticket$queue$name,_ticket$queue2;if(ticket.userId&&ticket.user){var _ticket$user,_ticket$user$name;setTicketUser((_ticket$user=ticket.user)===null||_ticket$user===void 0?void 0:(_ticket$user$name=_ticket$user.name)===null||_ticket$user$name===void 0?void 0:_ticket$user$name.toUpperCase());}setTicketQueueName((_ticket$queue=ticket.queue)===null||_ticket$queue===void 0?void 0:(_ticket$queue$name=_ticket$queue.name)===null||_ticket$queue$name===void 0?void 0:_ticket$queue$name.toUpperCase());setTicketQueueColor((_ticket$queue2=ticket.queue)===null||_ticket$queue2===void 0?void 0:_ticket$queue2.color);if(ticket.whatsappId&&ticket.whatsapp){var _ticket$whatsapp$name;setWhatsAppName((_ticket$whatsapp$name=ticket.whatsapp.name)===null||_ticket$whatsapp$name===void 0?void 0:_ticket$whatsapp$name.toUpperCase());}setTag(ticket===null||ticket===void 0?void 0:ticket.tags);return()=>{isMounted.current=false;};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);{/*CÓDIGO NOVO SAUDAÇÃO*/}const handleCloseTicket=async id=>{setTag(ticket===null||ticket===void 0?void 0:ticket.tags);setLoading(true);try{var _ticket$queue3;await api.put(`/tickets/${id}`,{status:\"closed\",userId:user===null||user===void 0?void 0:user.id,queueId:ticket===null||ticket===void 0?void 0:(_ticket$queue3=ticket.queue)===null||_ticket$queue3===void 0?void 0:_ticket$queue3.id,useIntegration:false,promptId:null,integrationId:null});}catch(err){setLoading(false);toastError(err);}if(isMounted.current){setLoading(false);}history.push(`/tickets/`);};useEffect(()=>{const renderLastInteractionLabel=()=>{let labelColor=\"\";let labelText=\"\";if(!ticket.lastMessage)return\"\";const lastInteractionDate=parseISO(ticket.updatedAt);const currentDate=new Date();const timeDifference=currentDate-lastInteractionDate;const hoursDifference=Math.floor(timeDifference/(1000*60*60));const minutesDifference=Math.floor(timeDifference/(1000*60));if(minutesDifference>=3&&minutesDifference<=10){labelText=`(${minutesDifference} m atrás)`;labelColor=\"green\";}else if(minutesDifference>=30&&minutesDifference<60){labelText=`(${minutesDifference} m atrás)`;labelColor=\"Orange\";}else if(minutesDifference>60&&hoursDifference<24){labelText=`(${hoursDifference} h atrás)`;labelColor=\"red\";}else if(hoursDifference>=24){labelText=`(${Math.floor(hoursDifference/24)} dias atrás)`;labelColor=\"red\";}return{labelText,labelColor};};// Função para atualizar o estado do componente\nconst updateLastInteractionLabel=()=>{const{labelText,labelColor}=renderLastInteractionLabel();setLastInteractionLabel(/*#__PURE__*/_jsx(Badge,{className:classes.lastInteractionLabel,style:{color:labelColor},children:labelText}));// Agendando a próxima atualização após 30 segundos\nsetTimeout(updateLastInteractionLabel,30*1000);};// Inicializando a primeira atualização\nupdateLastInteractionLabel();},[ticket]);// Executando apenas uma vez ao montar o componente\nconst handleReopenTicket=async id=>{setLoading(true);try{var _ticket$queue4;await api.put(`/tickets/${id}`,{status:\"open\",userId:user===null||user===void 0?void 0:user.id,queueId:ticket===null||ticket===void 0?void 0:(_ticket$queue4=ticket.queue)===null||_ticket$queue4===void 0?void 0:_ticket$queue4.id});}catch(err){setLoading(false);toastError(err);}if(isMounted.current){setLoading(false);}history.push(`/tickets/${ticket.uuid}`);};const handleAcepptTicket=async id=>{setLoading(true);try{await api.put(`/tickets/${id}`,{status:\"open\",userId:user===null||user===void 0?void 0:user.id});let settingIndex;try{const{data}=await api.get(\"/settings/\");settingIndex=data.filter(s=>s.key===\"sendGreetingAccepted\");}catch(err){toastError(err);}if(settingIndex[0].value===\"enabled\"&&!ticket.isGroup){handleSendMessage(ticket.id);}}catch(err){setLoading(false);toastError(err);}if(isMounted.current){setLoading(false);}// handleChangeTab(null, \"tickets\");\n// handleChangeTab(null, \"open\");\nhistory.push(`/tickets/${ticket.uuid}`);};const handleSendMessage=async id=>{const msg=`{{ms}} *{{name}}*, meu nome é *${user===null||user===void 0?void 0:user.name}* e agora vou prosseguir com seu atendimento!`;const message={read:1,fromMe:true,mediaUrl:\"\",body:`*Mensagem Automática:*\\n${msg.trim()}`};try{await api.post(`/messages/${id}`,message);}catch(err){toastError(err);}};{/*CÓDIGO NOVO SAUDAÇÃO*/}const handleSelectTicket=ticket=>{const code=uuidv4();const{id,uuid}=ticket;setCurrentTicket({id,uuid,code});};const renderTicketInfo=()=>{if(ticketUser){return/*#__PURE__*/_jsx(_Fragment,{children:ticket.chatbot&&/*#__PURE__*/_jsx(Tooltip,{title:\"Chatbot\",children:/*#__PURE__*/_jsx(AndroidIcon,{fontSize:\"small\",style:{color:grey[700],marginRight:5}})})});}else{return/*#__PURE__*/_jsx(_Fragment,{children:ticket.chatbot&&/*#__PURE__*/_jsx(Tooltip,{title:\"Chatbot\",children:/*#__PURE__*/_jsx(AndroidIcon,{fontSize:\"small\",style:{color:grey[700],marginRight:5}})})});}};const handleOpenTransferModal=()=>{setTransferTicketModalOpen(true);};const handleCloseTransferTicketModal=()=>{if(isMounted.current){setTransferTicketModalOpen(false);}};return/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(TransferTicketModalCustom,{modalOpen:transferTicketModalOpen,onClose:handleCloseTransferTicketModal,ticketid:ticket.id}),/*#__PURE__*/_jsx(TicketMessagesDialog,{open:openTicketMessageDialog,handleClose:()=>setOpenTicketMessageDialog(false),ticketId:ticket.id}),/*#__PURE__*/_jsxs(ListItem,{dense:true,button:true,onClick:e=>{if(ticket.status===\"pending\")return;handleSelectTicket(ticket);},selected:ticketId&&+ticketId===ticket.id,className:clsx(classes.ticket,{[classes.pendingTicket]:ticket.status===\"pending\"}),children:[/*#__PURE__*/_jsx(Tooltip,{arrow:true,placement:\"right\",title:((_ticket$queue5=ticket.queue)===null||_ticket$queue5===void 0?void 0:(_ticket$queue5$name=_ticket$queue5.name)===null||_ticket$queue5$name===void 0?void 0:_ticket$queue5$name.toUpperCase())||\"SEM FILA\",children:/*#__PURE__*/_jsx(\"span\",{style:{backgroundColor:((_ticket$queue6=ticket.queue)===null||_ticket$queue6===void 0?void 0:_ticket$queue6.color)||\"#7C7C7C\"},className:classes.ticketQueueColor})}),/*#__PURE__*/_jsx(ListItemAvatar,{children:ticket.status!==\"pending\"?/*#__PURE__*/_jsx(Avatar,{style:{marginTop:\"-20px\",marginLeft:\"-3px\",width:\"55px\",height:\"55px\",borderRadius:\"10%\",backgroundColor:generateColor(ticket===null||ticket===void 0?void 0:(_ticket$contact=ticket.contact)===null||_ticket$contact===void 0?void 0:_ticket$contact.number)},src:ticket===null||ticket===void 0?void 0:(_ticket$contact2=ticket.contact)===null||_ticket$contact2===void 0?void 0:_ticket$contact2.profilePicUrl,children:getInitials((ticket===null||ticket===void 0?void 0:(_ticket$contact3=ticket.contact)===null||_ticket$contact3===void 0?void 0:_ticket$contact3.name)||\"\")}):/*#__PURE__*/_jsx(Avatar,{style:{marginTop:\"-30px\",marginLeft:\"0px\",width:\"50px\",height:\"50px\",borderRadius:\"10%\",backgroundColor:generateColor(ticket===null||ticket===void 0?void 0:(_ticket$contact4=ticket.contact)===null||_ticket$contact4===void 0?void 0:_ticket$contact4.number)},src:ticket===null||ticket===void 0?void 0:(_ticket$contact5=ticket.contact)===null||_ticket$contact5===void 0?void 0:_ticket$contact5.profilePicUrl,children:getInitials((ticket===null||ticket===void 0?void 0:(_ticket$contact6=ticket.contact)===null||_ticket$contact6===void 0?void 0:_ticket$contact6.name)||\"\")})}),/*#__PURE__*/_jsx(ListItemText,{disableTypography:true,primary:/*#__PURE__*/_jsx(\"span\",{className:classes.contactNameWrapper,children:/*#__PURE__*/_jsxs(Typography,{noWrap:true,component:\"span\",variant:\"body2\",color:\"textPrimary\",children:[/*#__PURE__*/_jsxs(\"strong\",{children:[ticket.contact.name,\" \",lastInteractionLabel]}),/*#__PURE__*/_jsx(ListItemSecondaryAction,{children:/*#__PURE__*/_jsx(Box,{className:classes.ticketInfo1,children:renderTicketInfo()})}),profile===\"admin\"&&/*#__PURE__*/_jsx(Tooltip,{title:\"Espiar Conversa\",children:/*#__PURE__*/_jsx(VisibilityIcon,{onClick:()=>setOpenTicketMessageDialog(true),fontSize:\"small\",style:{color:blue[700],cursor:\"pointer\",marginLeft:10,verticalAlign:\"middle\"}})})]})}),secondary:/*#__PURE__*/_jsxs(\"span\",{className:classes.contactNameWrapper,children:[/*#__PURE__*/_jsxs(Typography,{className:classes.contactLastMessage,noWrap:true,component:\"span\",variant:\"body2\",color:\"textSecondary\",children:[[\"composing\",\"recording\"].includes(ticket===null||ticket===void 0?void 0:ticket.presence)?/*#__PURE__*/_jsx(\"span\",{className:classes.presence,children:presenceMessage[ticket.presence]}):/*#__PURE__*/_jsx(_Fragment,{children:ticket.lastMessage.includes(\"data:image/png;base64\")?/*#__PURE__*/_jsx(MarkdownWrapper,{children:\" Localiza\\xE7\\xE3o\"}):/*#__PURE__*/_jsx(MarkdownWrapper,{children:ticket.lastMessage})}),/*#__PURE__*/_jsxs(\"span\",{style:{marginTop:4},className:classes.secondaryContentSecond,children:[ticket!==null&&ticket!==void 0&&(_ticket$whatsapp=ticket.whatsapp)!==null&&_ticket$whatsapp!==void 0&&_ticket$whatsapp.name?/*#__PURE__*/_jsx(Badge,{className:classes.connectionTag,children:ticket===null||ticket===void 0?void 0:(_ticket$whatsapp2=ticket.whatsapp)===null||_ticket$whatsapp2===void 0?void 0:(_ticket$whatsapp2$nam=_ticket$whatsapp2.name)===null||_ticket$whatsapp2$nam===void 0?void 0:_ticket$whatsapp2$nam.toUpperCase()}):/*#__PURE__*/_jsx(\"br\",{}),ticketUser?/*#__PURE__*/_jsx(Badge,{style:{backgroundColor:\"#000000\"},className:classes.connectionTag,children:ticketUser}):/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(Badge,{style:{backgroundColor:((_ticket$queue7=ticket.queue)===null||_ticket$queue7===void 0?void 0:_ticket$queue7.color)||\"#7c7c7c\"},className:classes.connectionTag,children:((_ticket$queue8=ticket.queue)===null||_ticket$queue8===void 0?void 0:(_ticket$queue8$name=_ticket$queue8.name)===null||_ticket$queue8$name===void 0?void 0:_ticket$queue8$name.toUpperCase())||\"SEM FILA\"})]}),/*#__PURE__*/_jsx(\"span\",{style:{paddingTop:\"2px\"},className:classes.secondaryContentSecond,children:tag===null||tag===void 0?void 0:tag.map(tag=>{return/*#__PURE__*/_jsx(ContactTag,{tag:tag},`ticket-contact-tag-${ticket.id}-${tag.id}`);})})]}),/*#__PURE__*/_jsx(Badge,{className:classes.newMessagesCount,badgeContent:ticket.unreadMessages,classes:{badge:classes.badgeStyle}})]})}),/*#__PURE__*/_jsx(ListItemSecondaryAction,{children:ticket.lastMessage&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Typography,{className:classes.lastMessageTime,component:\"span\",variant:\"body2\",color:\"textSecondary\",children:isSameDay(parseISO(ticket.updatedAt),new Date())?/*#__PURE__*/_jsx(_Fragment,{children:format(parseISO(ticket.updatedAt),\"HH:mm\")}):/*#__PURE__*/_jsx(_Fragment,{children:format(parseISO(ticket.updatedAt),\"dd/MM/yyyy\")})}),/*#__PURE__*/_jsx(\"br\",{})]})}),/*#__PURE__*/_jsxs(\"span\",{className:classes.secondaryContentSecond,children:[ticket.status===\"pending\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"green\",color:\"white\",padding:\"0px\",bottom:\"17px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleAcepptTicket(ticket.id),children:i18n.t(\"ticketsList.buttons.accept\")}),/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"red\",color:\"white\",padding:\"0px\",bottom:\"0px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleCloseTicket(ticket.id),children:i18n.t(\"ticketsList.buttons.closed\")})]}),ticket.status===\"attending\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"green\",color:\"white\",padding:\"0px\",bottom:\"17px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleAcepptTicket(ticket.id),children:i18n.t(\"ticketsList.buttons.accept\")}),/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"red\",color:\"white\",padding:\"0px\",bottom:\"0px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleCloseTicket(ticket.id),children:i18n.t(\"ticketsList.buttons.closed\")})]}),ticket.status!==\"closed\"&&ticket.status!==\"pending\"&&ticket.status!==\"attending\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"blue\",color:\"white\",padding:\"0px\",bottom:\"17px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleOpenTransferModal(),children:i18n.t(\"ticketsList.buttons.transfer\")}),/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"red\",color:\"white\",padding:\"0px\",bottom:\"0px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleCloseTicket(ticket.id),children:i18n.t(\"ticketsList.buttons.closed\")})]}),ticket.status===\"closed\"&&/*#__PURE__*/_jsx(ButtonWithSpinner,{style:{backgroundColor:\"red\",color:\"white\",padding:\"0px\",bottom:\"0px\",borderRadius:\"0px\",left:\"8px\",fontSize:\"0.6rem\"},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleReopenTicket(ticket.id),children:i18n.t(\"ticketsList.buttons.reopen\")})]})]}),/*#__PURE__*/_jsx(Divider,{variant:\"inset\",component:\"li\"})]},ticket.id);};export default TicketListItemCustom;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}