{"ast":null,"code":"import React,{useState,useEffect,useContext}from\"react\";import*as Yup from\"yup\";import{Formik,Form,Field,FieldArray}from\"formik\";import{toast}from\"react-toastify\";import{Box,Button,CircularProgress,Dialog,DialogActions,DialogContent,DialogTitle,Divider,Grid,makeStyles,TextField}from\"@material-ui/core\";import IconButton from\"@material-ui/core/IconButton\";import Typography from\"@material-ui/core/Typography\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import AttachFileIcon from\"@material-ui/icons/AttachFile\";import{green}from\"@material-ui/core/colors\";import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexWrap:\"wrap\",gap:4},multFieldLine:{display:\"flex\",\"& > *:not(:last-child)\":{marginRight:theme.spacing(1)}},textField:{marginRight:theme.spacing(1),flex:1},extraAttr:{display:\"flex\",justifyContent:\"center\",alignItems:\"center\"},btnWrapper:{position:\"relative\"},buttonProgress:{color:green[500],position:\"absolute\",top:\"50%\",left:\"50%\",marginTop:-12,marginLeft:-12},formControl:{margin:theme.spacing(1),minWidth:2000},colorAdorment:{width:20,height:20}}));const FileListSchema=Yup.object().shape({name:Yup.string().min(3,\"nome muito curto\").required(\"Obrigatório\"),message:Yup.string().required(\"Obrigatório\")});const FilesModal=_ref=>{let{open,onClose,fileListId,reload}=_ref;const classes=useStyles();const{user}=useContext(AuthContext);const[files,setFiles]=useState([]);const[selectedFileNames,setSelectedFileNames]=useState([]);const initialState={name:\"\",message:\"\",options:[{name:\"\",path:\"\",mediaType:\"\"}]};const[fileList,setFileList]=useState(initialState);useEffect(()=>{try{(async()=>{if(!fileListId)return;const{data}=await api.get(`/files/${fileListId}`);setFileList(data);})();}catch(err){toastError(err);}},[fileListId,open]);const handleClose=()=>{setFileList(initialState);setFiles([]);onClose();};const handleSaveFileList=async values=>{const uploadFiles=async(options,filesOptions,id)=>{const formData=new FormData();formData.append(\"fileId\",id);formData.append(\"typeArch\",\"fileList\");filesOptions.forEach((fileOption,index)=>{if(fileOption.file){formData.append(\"files\",fileOption.file);formData.append(\"mediaType\",fileOption.file.type);formData.append(\"name\",options[index].name);formData.append(\"id\",options[index].id);}});try{const{data}=await api.post(`/files/uploadList/${id}`,formData);setFiles([]);return data;}catch(err){toastError(err);}return null;};const fileData={...values,userId:user.id};try{if(fileListId){const{data}=await api.put(`/files/${fileListId}`,fileData);if(data.options.length>0)uploadFiles(data.options,values.options,fileListId);}else{const{data}=await api.post(\"/files\",fileData);if(data.options.length>0)uploadFiles(data.options,values.options,data.id);}toast.success(i18n.t(\"fileModal.success\"));if(typeof reload=='function'){reload();}}catch(err){toastError(err);}handleClose();};return/*#__PURE__*/_jsx(\"div\",{className:classes.root,children:/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:handleClose,maxWidth:\"md\",fullWidth:true,scroll:\"paper\",children:[/*#__PURE__*/_jsx(DialogTitle,{id:\"form-dialog-title\",children:fileListId?`${i18n.t(\"fileModal.title.edit\")}`:`${i18n.t(\"fileModal.title.add\")}`}),/*#__PURE__*/_jsx(Formik,{initialValues:fileList,enableReinitialize:true,validationSchema:FileListSchema,onSubmit:(values,actions)=>{setTimeout(()=>{handleSaveFileList(values);actions.setSubmitting(false);},400);},children:_ref2=>{let{touched,errors,isSubmitting,values}=_ref2;return/*#__PURE__*/_jsxs(Form,{children:[/*#__PURE__*/_jsxs(DialogContent,{dividers:true,children:[/*#__PURE__*/_jsx(\"div\",{className:classes.multFieldLine,children:/*#__PURE__*/_jsx(Field,{as:TextField,label:i18n.t(\"fileModal.form.name\"),name:\"name\",error:touched.name&&Boolean(errors.name),helperText:touched.name&&errors.name,variant:\"outlined\",margin:\"dense\",fullWidth:true})}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"div\",{className:classes.multFieldLine,children:/*#__PURE__*/_jsx(Field,{as:TextField,label:i18n.t(\"fileModal.form.message\"),type:\"message\",multiline:true,minRows:5,fullWidth:true,name:\"message\",error:touched.message&&Boolean(errors.message),helperText:touched.message&&errors.message,variant:\"outlined\",margin:\"dense\"})}),/*#__PURE__*/_jsx(Typography,{style:{marginBottom:8,marginTop:12},variant:\"subtitle1\",children:i18n.t(\"fileModal.form.fileOptions\")}),/*#__PURE__*/_jsx(FieldArray,{name:\"options\",children:_ref3=>{let{push,remove}=_ref3;return/*#__PURE__*/_jsxs(_Fragment,{children:[values.options&&values.options.length>0&&values.options.map((info,index)=>/*#__PURE__*/_jsx(\"div\",{className:classes.extraAttr,children:/*#__PURE__*/_jsxs(Grid,{container:true,spacing:0,children:[/*#__PURE__*/_jsx(Grid,{xs:6,md:10,item:true,children:/*#__PURE__*/_jsx(Field,{as:TextField,label:i18n.t(\"fileModal.form.extraName\"),name:`options[${index}].name`,variant:\"outlined\",margin:\"dense\",multiline:true,fullWidth:true,minRows:2,className:classes.textField})}),/*#__PURE__*/_jsxs(Grid,{xs:2,md:2,item:true,style:{display:'flex',alignItems:'center',justifyContent:'flex-end'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"file\",onChange:e=>{const selectedFile=e.target.files[0];const updatedOptions=[...values.options];updatedOptions[index].file=selectedFile;setFiles('options',updatedOptions);// Atualize a lista selectedFileNames para o campo específico\nconst updatedFileNames=[...selectedFileNames];updatedFileNames[index]=selectedFile?selectedFile.name:'';setSelectedFileNames(updatedFileNames);},style:{display:'none'},name:`options[${index}].file`,id:`file-upload-${index}`}),/*#__PURE__*/_jsx(\"label\",{htmlFor:`file-upload-${index}`,children:/*#__PURE__*/_jsx(IconButton,{component:\"span\",children:/*#__PURE__*/_jsx(AttachFileIcon,{})})}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>remove(index),children:/*#__PURE__*/_jsx(DeleteOutlineIcon,{})})]}),/*#__PURE__*/_jsx(Grid,{xs:12,md:12,item:true,children:info.path?info.path:selectedFileNames[index]})]})},`${index}-info`)),/*#__PURE__*/_jsx(\"div\",{className:classes.extraAttr,children:/*#__PURE__*/_jsx(Button,{style:{flex:1,marginTop:8},variant:\"outlined\",color:\"primary\",onClick:()=>{push({name:\"\",path:\"\"});setSelectedFileNames([...selectedFileNames,\"\"]);},children:`+ ${i18n.t(\"fileModal.buttons.fileOptions\")}`})})]});}})]}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleClose,color:\"secondary\",disabled:isSubmitting,variant:\"outlined\",children:i18n.t(\"fileModal.buttons.cancel\")}),/*#__PURE__*/_jsxs(Button,{type:\"submit\",color:\"primary\",disabled:isSubmitting,variant:\"contained\",className:classes.btnWrapper,children:[fileListId?`${i18n.t(\"fileModal.buttons.okEdit\")}`:`${i18n.t(\"fileModal.buttons.okAdd\")}`,isSubmitting&&/*#__PURE__*/_jsx(CircularProgress,{size:24,className:classes.buttonProgress})]})]})]});}})]})});};export default FilesModal;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}